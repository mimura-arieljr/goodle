import { QuestionTypes } from "../types/BaseQuestionType.js";
import { prepareQuestionSet } from "../utils/questionsManager.js";
import { isAnswerValid } from "../utils/answersManager.js";
import { startCountdownTimer } from "../utils/timerManager.js";
import { resultsView } from "./resultsView.js";
const answerInput = document.getElementById("answer-input");
const correctAnswer = document.getElementById("correct-answer-text");
const questionTextEl = document.getElementById("question-text");
const choicesContainer = document.getElementById("choices-container");
const CORRECT_BORDER_COLOR = "border-green";
const INCORRECT_BORDER_COLOR = "border-red";
export async function questionsView(subjectsPage, questionsPage, subject) {
    const backBtn = document.getElementById("questions-back-btn");
    const submitBtn = document.getElementById("answer-submit-btn");
    let score = 0;
    let currentQuestionIndex = 0;
    // Event listeners
    backBtn.addEventListener("click", () => {
        subjectsPage.classList.remove("hidden");
        questionsPage.classList.add("hidden");
    });
    // Use onclick instead of eventListener
    // Avoid listener getting stacked multiple times on the same button. 
    // This causes handleAnswerSubmission() to be called more than once â€” even with outdated state. 
    submitBtn.onclick = handleAnswerSubmission;
    // Prepare and show the questions
    const questions = await prepareQuestionSet(subject);
    showQuestion(currentQuestionIndex, questions);
    // Handle answer submit
    function handleAnswerSubmission() {
        const userAnswer = answerInput.value;
        const isValid = isAnswerValid(userAnswer, questions[currentQuestionIndex]);
        handleAnswerFeedback(isValid);
        if (!isValid) {
            correctAnswer.classList.remove("invisible");
            correctAnswer.innerText = `Correct Answer: ${questions[currentQuestionIndex].Answer}`;
        }
        submitBtn.disabled = true;
        setTimeout(() => {
            answerInput.classList.remove(INCORRECT_BORDER_COLOR, CORRECT_BORDER_COLOR);
            correctAnswer.classList.add("invisible");
            submitBtn.disabled = false;
            moveToNextQuestion();
        }, 2000);
    }
    function moveToNextQuestion() {
        currentQuestionIndex++;
        if (currentQuestionIndex < questions.length) {
            showQuestion(currentQuestionIndex, questions);
        }
        else {
            console.log("All questions completed!");
            resultsView(subjectsPage, questionsPage, score);
        }
    }
    function showQuestion(index, questions) {
        const q = questions[index];
        questionTextEl.innerText = q.Question;
        answerInput.value = "";
        // Handle multiple choice questions
        const shouldUseChoices = q.QuestionType === QuestionTypes.MULT_CHOICE || q.QuestionType === QuestionTypes.MULT_ANSWER;
        answerInput.classList.toggle("hidden", shouldUseChoices);
        choicesContainer.innerHTML = "";
        if (shouldUseChoices && q.Options) {
            if (q.QuestionType === QuestionTypes.MULT_CHOICE) {
                handleMultipleChoiceQuestions(q);
            }
            else {
                handleMultipleAnswersQuestion(q);
            }
        }
        startCountdownTimer(handleAnswerSubmission);
    }
    function handleAnswerFeedback(isCorrect) {
        if (isCorrect) {
            answerInput.classList.add(CORRECT_BORDER_COLOR);
            score++;
        }
        else {
            answerInput.classList.add(INCORRECT_BORDER_COLOR);
        }
    }
    function handleMultipleAnswersQuestion(q) {
        Object.entries(q.Options).forEach(([key, value]) => {
            const choiceEl = createChoiceButtonEl(key, value);
            choiceEl.addEventListener("click", () => {
                const wasSelected = choiceEl.classList.contains("bg-orange-300");
                choiceEl.classList.toggle("bg-orange-300", !wasSelected);
                choiceEl.classList.toggle("bg-white", wasSelected);
                const answers = answerInput.value.split(',').map(a => a.trim()).filter(Boolean);
                if (!wasSelected) {
                    if (!answers.includes(key))
                        answers.push(key);
                }
                else {
                    const idx = answers.indexOf(key);
                    if (idx > -1)
                        answers.splice(idx, 1);
                }
                answerInput.value = answers.join(',');
            });
            choicesContainer.appendChild(choiceEl);
        });
    }
    function handleMultipleChoiceQuestions(q) {
        Object.entries(q.Options).forEach(([key, value]) => {
            const choiceEl = createChoiceButtonEl(key, value);
            choiceEl.addEventListener("click", () => {
                Array.from(choicesContainer.children).forEach(btn => {
                    btn.classList.remove("bg-orange-300");
                    btn.classList.add("bg-white");
                });
                choiceEl.classList.add("bg-orange-300");
                choiceEl.classList.remove("bg-white");
                answerInput.value = key;
            });
            choicesContainer.appendChild(choiceEl);
        });
    }
    function createChoiceButtonEl(key, value) {
        const choiceEl = document.createElement("button");
        choiceEl.className = "choice-btn py-2 px-4 mb-2 text-black bg-white rounded hover:bg-orange-200 transition font-anonymouspro w-full text-left";
        choiceEl.innerText = `${key.toUpperCase()}: ${value}`;
        return choiceEl;
    }
    ;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVlc3Rpb25zVmlldy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy92aWV3cy9xdWVzdGlvbnNWaWV3LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBb0IsYUFBYSxFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDL0UsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDbEUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQzNELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUUvQyxNQUFNLFdBQVcsR0FBRyxRQUFRLENBQUMsY0FBYyxDQUFDLGNBQWMsQ0FBcUIsQ0FBQztBQUNoRixNQUFNLGFBQWEsR0FBRyxRQUFRLENBQUMsY0FBYyxDQUFDLHFCQUFxQixDQUFnQixDQUFDO0FBQ3BGLE1BQU0sY0FBYyxHQUFHLFFBQVEsQ0FBQyxjQUFjLENBQUMsZUFBZSxDQUFnQixDQUFDO0FBQy9FLE1BQU0sZ0JBQWdCLEdBQUcsUUFBUSxDQUFDLGNBQWMsQ0FBQyxtQkFBbUIsQ0FBZ0IsQ0FBQztBQUNyRixNQUFNLG9CQUFvQixHQUFHLGNBQWMsQ0FBQztBQUM1QyxNQUFNLHNCQUFzQixHQUFHLFlBQVksQ0FBQztBQUU1QyxNQUFNLENBQUMsS0FBSyxVQUFVLGFBQWEsQ0FBQyxZQUF5QixFQUFFLGFBQTBCLEVBQUUsT0FBZTtJQUN0RyxNQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsY0FBYyxDQUFDLG9CQUFvQixDQUFzQixDQUFDO0lBQ25GLE1BQU0sU0FBUyxHQUFHLFFBQVEsQ0FBQyxjQUFjLENBQUMsbUJBQW1CLENBQXNCLENBQUM7SUFDcEYsSUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFDO0lBQ2QsSUFBSSxvQkFBb0IsR0FBRyxDQUFDLENBQUM7SUFFN0Isa0JBQWtC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LEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQztnQkFDeEMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUM7Z0JBQ3RDLFdBQVcsQ0FBQyxLQUFLLEdBQUcsR0FBRyxDQUFDO1lBQzVCLENBQUMsQ0FBQyxDQUFDO1lBRUgsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzNDLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELFNBQVMsb0JBQW9CLENBQUMsR0FBVyxFQUFFLEtBQWE7UUFDcEQsTUFBTSxRQUFRLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNsRCxRQUFRLENBQUMsU0FBUyxHQUFHLHlIQUF5SCxDQUFDO1FBQy9JLFFBQVEsQ0FBQyxTQUFTLEdBQUcsR0FBRyxHQUFHLENBQUMsV0FBVyxFQUFFLEtBQUssS0FBSyxFQUFFLENBQUM7UUFDdEQsT0FBTyxRQUFRLENBQUM7SUFDcEIsQ0FBQztJQUFBLENBQUM7QUFFTixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQmFzZVF1ZXN0aW9uVHlwZSwgUXVlc3Rpb25UeXBlcyB9IGZyb20gXCIuLi90eXBlcy9CYXNlUXVlc3Rpb25UeXBlLmpzXCI7XG5pbXBvcnQgeyBwcmVwYXJlUXVlc3Rpb25TZXQgfSBmcm9tIFwiLi4vdXRpbHMvcXVlc3Rpb25zTWFuYWdlci5qc1wiO1xuaW1wb3J0IHsgaXNBbnN3ZXJWYWxpZCB9IGZyb20gXCIuLi91dGlscy9hbnN3ZXJzTWFuYWdlci5qc1wiO1xuaW1wb3J0IHsgc3RhcnRDb3VudGRvd25UaW1lciB9IGZyb20gXCIuLi91dGlscy90aW1lck1hbmFnZXIuanNcIjtcbmltcG9ydCB7IHJlc3VsdHNWaWV3IH0gZnJvbSBcIi4vcmVzdWx0c1ZpZXcuanNcIjtcblxuY29uc3QgYW5zd2VySW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImFuc3dlci1pbnB1dFwiKSBhcyBIVE1MSW5wdXRFbGVtZW50O1xuY29uc3QgY29ycmVjdEFuc3dlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiY29ycmVjdC1hbnN3ZXItdGV4dFwiKSBhcyBIVE1MRWxlbWVudDtcbmNvbnN0IHF1ZXN0aW9uVGV4dEVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJxdWVzdGlvbi10ZXh0XCIpIGFzIEhUTUxFbGVtZW50O1xuY29uc3QgY2hvaWNlc0NvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiY2hvaWNlcy1jb250YWluZXJcIikgYXMgSFRNTEVsZW1lbnQ7XG5jb25zdCBDT1JSRUNUX0JPUkRFUl9DT0xPUiA9IFwiYm9yZGVyLWdyZWVuXCI7XG5jb25zdCBJTkNPUlJFQ1RfQk9SREVSX0NPTE9SID0gXCJib3JkZXItcmVkXCI7XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBxdWVzdGlvbnNWaWV3KHN1YmplY3RzUGFnZTogSFRNTEVsZW1lbnQsIHF1ZXN0aW9uc1BhZ2U6IEhUTUxFbGVtZW50LCBzdWJqZWN0OiBzdHJpbmcpIHtcbiAgICBjb25zdCBiYWNrQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJxdWVzdGlvbnMtYmFjay1idG5cIikgYXMgSFRNTEJ1dHRvbkVsZW1lbnQ7XG4gICAgY29uc3Qgc3VibWl0QnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJhbnN3ZXItc3VibWl0LWJ0blwiKSBhcyBIVE1MQnV0dG9uRWxlbWVudDtcbiAgICBsZXQgc2NvcmUgPSAwO1xuICAgIGxldCBjdXJyZW50UXVlc3Rpb25JbmRleCA9IDA7XG5cbiAgICAvLyBFdmVudCBsaXN0ZW5lcnNcbiAgICBiYWNrQnRuLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCAoKSA9PiB7XG4gICAgICAgIHN1YmplY3RzUGFnZS5jbGFzc0xpc3QucmVtb3ZlKFwiaGlkZGVuXCIpO1xuICAgICAgICBxdWVzdGlvbnNQYWdlLmNsYXNzTGlzdC5hZGQoXCJoaWRkZW5cIik7XG4gICAgfSk7XG5cbiAgICAvLyBVc2Ugb25jbGljayBpbnN0ZWFkIG9mIGV2ZW50TGlzdGVuZXJcbiAgICAvLyBBdm9pZCBsaXN0ZW5lciBnZXR0aW5nIHN0YWNrZWQgbXVsdGlwbGUgdGltZXMgb24gdGhlIHNhbWUgYnV0dG9uLiBcbiAgICAvLyBUaGlzIGNhdXNlcyBoYW5kbGVBbnN3ZXJTdWJtaXNzaW9uKCkgdG8gYmUgY2FsbGVkIG1vcmUgdGhhbiBvbmNlIOKAlCBldmVuIHdpdGggb3V0ZGF0ZWQgc3RhdGUuIFxuICAgIHN1Ym1pdEJ0bi5vbmNsaWNrID0gaGFuZGxlQW5zd2VyU3VibWlzc2lvbjtcblxuICAgIC8vIFByZXBhcmUgYW5kIHNob3cgdGhlIHF1ZXN0aW9uc1xuICAgIGNvbnN0IHF1ZXN0aW9ucyA9IGF3YWl0IHByZXBhcmVRdWVzdGlvblNldChzdWJqZWN0KTtcbiAgICBzaG93UXVlc3Rpb24oY3VycmVudFF1ZXN0aW9uSW5kZXgsIHF1ZXN0aW9ucyk7XG5cbiAgICAvLyBIYW5kbGUgYW5zd2VyIHN1Ym1pdFxuICAgIGZ1bmN0aW9uIGhhbmRsZUFuc3dlclN1Ym1pc3Npb24oKSB7XG4gICAgICAgIGNvbnN0IHVzZXJBbnN3ZXIgPSBhbnN3ZXJJbnB1dC52YWx1ZTtcbiAgICAgICAgY29uc3QgaXNWYWxpZCA9IGlzQW5zd2VyVmFsaWQodXNlckFuc3dlciwgcXVlc3Rpb25zW2N1cnJlbnRRdWVzdGlvbkluZGV4XSk7XG5cbiAgICAgICAgaGFuZGxlQW5zd2VyRmVlZGJhY2soaXNWYWxpZCk7XG5cbiAgICAgICAgaWYgKCFpc1ZhbGlkKSB7XG4gICAgICAgICAgICBjb3JyZWN0QW5zd2VyLmNsYXNzTGlzdC5yZW1vdmUoXCJpbnZpc2libGVcIik7XG4gICAgICAgICAgICBjb3JyZWN0QW5zd2VyLmlubmVyVGV4dCA9IGBDb3JyZWN0IEFuc3dlcjogJHtxdWVzdGlvbnNbY3VycmVudFF1ZXN0aW9uSW5kZXhdLkFuc3dlcn1gO1xuICAgICAgICB9XG5cbiAgICAgICAgc3VibWl0QnRuLmRpc2FibGVkID0gdHJ1ZTtcblxuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIGFuc3dlcklucHV0LmNsYXNzTGlzdC5yZW1vdmUoSU5DT1JSRUNUX0JPUkRFUl9DT0xPUiwgQ09SUkVDVF9CT1JERVJfQ09MT1IpO1xuICAgICAgICAgICAgY29ycmVjdEFuc3dlci5jbGFzc0xpc3QuYWRkKFwiaW52aXNpYmxlXCIpO1xuICAgICAgICAgICAgc3VibWl0QnRuLmRpc2FibGVkID0gZmFsc2U7XG5cbiAgICAgICAgICAgIG1vdmVUb05leHRRdWVzdGlvbigpO1xuICAgICAgICB9LCAyMDAwKTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBtb3ZlVG9OZXh0UXVlc3Rpb24oKSB7XG4gICAgICAgIGN1cnJlbnRRdWVzdGlvbkluZGV4Kys7XG4gICAgICAgIGlmIChjdXJyZW50UXVlc3Rpb25JbmRleCA8IHF1ZXN0aW9ucy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHNob3dRdWVzdGlvbihjdXJyZW50UXVlc3Rpb25JbmRleCwgcXVlc3Rpb25zKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiQWxsIHF1ZXN0aW9ucyBjb21wbGV0ZWQhXCIpO1xuICAgICAgICAgICAgcmVzdWx0c1ZpZXcoc3ViamVjdHNQYWdlLCBxdWVzdGlvbnNQYWdlLCBzY29yZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBmdW5jdGlvbiBzaG93UXVlc3Rpb24oaW5kZXg6IG51bWJlciwgcXVlc3Rpb25zOiBCYXNlUXVlc3Rpb25UeXBlW10pIHtcbiAgICAgICAgY29uc3QgcSA9IHF1ZXN0aW9uc1tpbmRleF07XG4gICAgICAgIHF1ZXN0aW9uVGV4dEVsLmlubmVyVGV4dCA9IHEuUXVlc3Rpb247XG4gICAgICAgIGFuc3dlcklucHV0LnZhbHVlID0gXCJcIjtcblxuICAgICAgICAvLyBIYW5kbGUgbXVsdGlwbGUgY2hvaWNlIHF1ZXN0aW9uc1xuICAgICAgICBjb25zdCBzaG91bGRVc2VDaG9pY2VzID0gcS5RdWVzdGlvblR5cGUgPT09IFF1ZXN0aW9uVHlwZXMuTVVMVF9DSE9JQ0UgfHwgcS5RdWVzdGlvblR5cGUgPT09IFF1ZXN0aW9uVHlwZXMuTVVMVF9BTlNXRVI7XG4gICAgICAgIGFuc3dlcklucHV0LmNsYXNzTGlzdC50b2dnbGUoXCJoaWRkZW5cIiwgc2hvdWxkVXNlQ2hvaWNlcyk7XG4gICAgICAgIGNob2ljZXNDb250YWluZXIuaW5uZXJIVE1MID0gXCJcIjtcblxuICAgICAgICBpZiAoc2hvdWxkVXNlQ2hvaWNlcyAmJiBxLk9wdGlvbnMpIHtcbiAgICAgICAgICAgIGlmIChxLlF1ZXN0aW9uVHlwZSA9PT0gUXVlc3Rpb25UeXBlcy5NVUxUX0NIT0lDRSkge1xuICAgICAgICAgICAgICAgIGhhbmRsZU11bHRpcGxlQ2hvaWNlUXVlc3Rpb25zKHEpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBoYW5kbGVNdWx0aXBsZUFuc3dlcnNRdWVzdGlvbihxKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHN0YXJ0Q291bnRkb3duVGltZXIoaGFuZGxlQW5zd2VyU3VibWlzc2lvbik7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gaGFuZGxlQW5zd2VyRmVlZGJhY2soaXNDb3JyZWN0OiBib29sZWFuKSB7XG4gICAgICAgIGlmIChpc0NvcnJlY3QpIHtcbiAgICAgICAgICAgIGFuc3dlcklucHV0LmNsYXNzTGlzdC5hZGQoQ09SUkVDVF9CT1JERVJfQ09MT1IpO1xuICAgICAgICAgICAgc2NvcmUrKztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGFuc3dlcklucHV0LmNsYXNzTGlzdC5hZGQoSU5DT1JSRUNUX0JPUkRFUl9DT0xPUik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBmdW5jdGlvbiBoYW5kbGVNdWx0aXBsZUFuc3dlcnNRdWVzdGlvbihxOiBCYXNlUXVlc3Rpb25UeXBlKTogdm9pZCB7XG4gICAgICAgIE9iamVjdC5lbnRyaWVzKHEuT3B0aW9ucyEpLmZvckVhY2goKFtrZXksIHZhbHVlXSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY2hvaWNlRWwgPSBjcmVhdGVDaG9pY2VCdXR0b25FbChrZXksIHZhbHVlKTtcbiAgICAgICAgICAgIGNob2ljZUVsLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3Qgd2FzU2VsZWN0ZWQgPSBjaG9pY2VFbC5jbGFzc0xpc3QuY29udGFpbnMoXCJiZy1vcmFuZ2UtMzAwXCIpO1xuICAgICAgICAgICAgICAgIGNob2ljZUVsLmNsYXNzTGlzdC50b2dnbGUoXCJiZy1vcmFuZ2UtMzAwXCIsICF3YXNTZWxlY3RlZCk7XG4gICAgICAgICAgICAgICAgY2hvaWNlRWwuY2xhc3NMaXN0LnRvZ2dsZShcImJnLXdoaXRlXCIsIHdhc1NlbGVjdGVkKTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGFuc3dlcnMgPSBhbnN3ZXJJbnB1dC52YWx1ZS5zcGxpdCgnLCcpLm1hcChhID0+IGEudHJpbSgpKS5maWx0ZXIoQm9vbGVhbik7XG4gICAgICAgICAgICAgICAgaWYgKCF3YXNTZWxlY3RlZCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWFuc3dlcnMuaW5jbHVkZXMoa2V5KSkgYW5zd2Vycy5wdXNoKGtleSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaWR4ID0gYW5zd2Vycy5pbmRleE9mKGtleSk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpZHggPiAtMSkgYW5zd2Vycy5zcGxpY2UoaWR4LCAxKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYW5zd2VySW5wdXQudmFsdWUgPSBhbnN3ZXJzLmpvaW4oJywnKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBjaG9pY2VzQ29udGFpbmVyLmFwcGVuZENoaWxkKGNob2ljZUVsKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gaGFuZGxlTXVsdGlwbGVDaG9pY2VRdWVzdGlvbnMocTogQmFzZVF1ZXN0aW9uVHlwZSk6IHZvaWQge1xuICAgICAgICBPYmplY3QuZW50cmllcyhxLk9wdGlvbnMhKS5mb3JFYWNoKChba2V5LCB2YWx1ZV0pID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNob2ljZUVsID0gY3JlYXRlQ2hvaWNlQnV0dG9uRWwoa2V5LCB2YWx1ZSk7XG4gICAgICAgICAgICBjaG9pY2VFbC5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgKCkgPT4ge1xuICAgICAgICAgICAgICAgIEFycmF5LmZyb20oY2hvaWNlc0NvbnRhaW5lci5jaGlsZHJlbikuZm9yRWFjaChidG4gPT4ge1xuICAgICAgICAgICAgICAgICAgICBidG4uY2xhc3NMaXN0LnJlbW92ZShcImJnLW9yYW5nZS0zMDBcIik7XG4gICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKFwiYmctd2hpdGVcIik7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgY2hvaWNlRWwuY2xhc3NMaXN0LmFkZChcImJnLW9yYW5nZS0zMDBcIik7XG4gICAgICAgICAgICAgICAgY2hvaWNlRWwuY2xhc3NMaXN0LnJlbW92ZShcImJnLXdoaXRlXCIpO1xuICAgICAgICAgICAgICAgIGFuc3dlcklucHV0LnZhbHVlID0ga2V5O1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGNob2ljZXNDb250YWluZXIuYXBwZW5kQ2hpbGQoY2hvaWNlRWwpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBjcmVhdGVDaG9pY2VCdXR0b25FbChrZXk6IHN0cmluZywgdmFsdWU6IHN0cmluZyk6IEhUTUxCdXR0b25FbGVtZW50IHtcbiAgICAgICAgY29uc3QgY2hvaWNlRWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYnV0dG9uXCIpO1xuICAgICAgICBjaG9pY2VFbC5jbGFzc05hbWUgPSBcImNob2ljZS1idG4gcHktMiBweC00IG1iLTIgdGV4dC1ibGFjayBiZy13aGl0ZSByb3VuZGVkIGhvdmVyOmJnLW9yYW5nZS0yMDAgdHJhbnNpdGlvbiBmb250LWFub255bW91c3BybyB3LWZ1bGwgdGV4dC1sZWZ0XCI7XG4gICAgICAgIGNob2ljZUVsLmlubmVyVGV4dCA9IGAke2tleS50b1VwcGVyQ2FzZSgpfTogJHt2YWx1ZX1gO1xuICAgICAgICByZXR1cm4gY2hvaWNlRWw7XG4gICAgfTtcblxufSJdfQ==