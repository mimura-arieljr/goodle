import { QuestionTypes } from "../types/BaseQuestionType.js";
import { prepareQuestionSet } from "../utils/questionsManager.js";
import { isAnswerValid } from "../utils/answersManager.js";
import { startCountdownTimer } from "../utils/timerManager.js";
import { resultsView } from "./resultsView.js";
import { Configuration } from "../common/config.js";
const { ApplicationConfig, BackgroundColors, BorderColors } = Configuration;
const { MULTIPLE_CHOICE_BG_COLOR, MULTIPLE_CHOICE_SELECTED_BG_COLOR, MULTIPLE_CHOICE_CORRECT_BG_COLOR } = BackgroundColors;
const { CORRECT_BORDER_COLOR, INCORRECT_BORDER_COLOR } = BorderColors;
const answerInput = document.getElementById("answer-input");
const correctAnswerText = document.getElementById("correct-answer-text");
const questionTextEl = document.getElementById("question-text");
const choicesContainer = document.getElementById("choices-container");
export async function questionsView(subjectsPage, questionsPage, subject) {
    const backBtn = document.getElementById("questions-back-btn");
    const submitBtn = document.getElementById("answer-submit-btn");
    let score = 0;
    let currentQuestionIndex = 0;
    // Event listeners
    backBtn.addEventListener("click", () => {
        subjectsPage.classList.remove("hidden");
        questionsPage.classList.add("hidden");
    });
    // Use onclick instead of eventListener
    // To avoid listener getting stacked multiple times on the same button. 
    // This causes handleAnswerSubmission() to be called more than once â€” even with outdated state. 
    submitBtn.onclick = handleAnswerSubmission;
    // Prepare and show the questions
    const questions = await prepareQuestionSet(subject);
    showQuestion(currentQuestionIndex, questions);
    // Handle answer submit
    function handleAnswerSubmission() {
        const question = questions[currentQuestionIndex];
        const { Answer: correctAnswer, QuestionType: questionType } = question;
        const userAnswer = answerInput.value;
        const isValid = isAnswerValid(userAnswer, question);
        const isMultipleChoice = questionType === QuestionTypes.MULT_CHOICE || questionType === QuestionTypes.MULT_ANSWER;
        if (isMultipleChoice) {
            handleMultChoiceAnswerFeedback(isValid, correctAnswer);
        }
        else {
            handleAnswerFeedback(isValid);
        }
        if (!isValid) {
            correctAnswerText.classList.remove("invisible");
            correctAnswerText.innerText = `Correct Answer: ${correctAnswer}`;
        }
        submitBtn.disabled = true;
        setTimeout(() => {
            answerInput.classList.remove(INCORRECT_BORDER_COLOR, CORRECT_BORDER_COLOR);
            correctAnswerText.classList.add("invisible");
            submitBtn.disabled = false;
            moveToNextQuestion();
        }, ApplicationConfig.DELAY_BEFORE_NEXT_QUESTION);
    }
    function moveToNextQuestion() {
        currentQuestionIndex++;
        if (currentQuestionIndex < questions.length) {
            showQuestion(currentQuestionIndex, questions);
        }
        else {
            console.log("All questions completed!");
            resultsView(subjectsPage, questionsPage, score);
        }
    }
    function showQuestion(index, questions) {
        const q = questions[index];
        questionTextEl.innerText = q.Question;
        answerInput.value = "";
        // Handle multiple choice questions
        const shouldUseChoices = q.QuestionType === QuestionTypes.MULT_CHOICE || q.QuestionType === QuestionTypes.MULT_ANSWER;
        answerInput.classList.toggle("hidden", shouldUseChoices);
        choicesContainer.innerHTML = "";
        if (shouldUseChoices && q.Options) {
            if (q.QuestionType === QuestionTypes.MULT_CHOICE) {
                handleMultipleChoiceQuestions(q);
            }
            else {
                handleMultipleAnswersQuestion(q);
            }
        }
        startCountdownTimer(handleAnswerSubmission);
    }
    function handleAnswerFeedback(isCorrect) {
        if (isCorrect) {
            answerInput.classList.add(CORRECT_BORDER_COLOR);
            score++;
        }
        else {
            answerInput.classList.add(INCORRECT_BORDER_COLOR);
        }
    }
    function handleMultChoiceAnswerFeedback(isCorrect, correctAnswers) {
        if (!isCorrect)
            return;
        if (Array.isArray(correctAnswers)) {
            const correctAnswer = correctAnswers.map(a => a.trim().toUpperCase()).sort();
            correctAnswer.forEach(a => {
                const choiceEl = document.getElementById(`choice-${a}`);
                if (choiceEl) {
                    choiceEl.classList.remove(MULTIPLE_CHOICE_SELECTED_BG_COLOR);
                    choiceEl.classList.add(MULTIPLE_CHOICE_CORRECT_BG_COLOR);
                }
            });
        }
        else {
            const uppercaseAnswer = correctAnswers.trim().toUpperCase();
            const choiceEl = document.getElementById(`choice-${uppercaseAnswer}`);
            choiceEl.classList.remove(MULTIPLE_CHOICE_SELECTED_BG_COLOR);
            choiceEl.classList.add(MULTIPLE_CHOICE_CORRECT_BG_COLOR);
        }
        score++;
    }
    function handleMultipleAnswersQuestion(q) {
        Object.entries(q.Options).forEach(([key, value]) => {
            const choiceEl = createChoiceButtonEl(key, value);
            choiceEl.addEventListener("click", () => {
                const wasSelected = choiceEl.classList.contains(MULTIPLE_CHOICE_SELECTED_BG_COLOR);
                choiceEl.classList.toggle(MULTIPLE_CHOICE_SELECTED_BG_COLOR, !wasSelected);
                choiceEl.classList.toggle(MULTIPLE_CHOICE_BG_COLOR, wasSelected);
                const answers = answerInput.value.split(',').map(a => a.trim()).filter(Boolean);
                if (!wasSelected) {
                    if (!answers.includes(key))
                        answers.push(key);
                }
                else {
                    const idx = answers.indexOf(key);
                    if (idx > -1)
                        answers.splice(idx, 1);
                }
                answerInput.value = answers.join(',');
            });
            choicesContainer.appendChild(choiceEl);
        });
    }
    function handleMultipleChoiceQuestions(q) {
        Object.entries(q.Options).forEach(([key, value]) => {
            const choiceEl = createChoiceButtonEl(key, value);
            choiceEl.addEventListener("click", () => {
                Array.from(choicesContainer.children).forEach(btn => {
                    btn.classList.remove(MULTIPLE_CHOICE_SELECTED_BG_COLOR);
                    btn.classList.add(MULTIPLE_CHOICE_BG_COLOR);
                });
                choiceEl.classList.add(MULTIPLE_CHOICE_SELECTED_BG_COLOR);
                choiceEl.classList.remove(MULTIPLE_CHOICE_BG_COLOR);
                answerInput.value = key;
            });
            choicesContainer.appendChild(choiceEl);
        });
    }
    function createChoiceButtonEl(key, value) {
        const choiceEl = document.createElement("button");
        const uppercaseKey = key.toUpperCase();
        choiceEl.className = "choice-btn py-2 px-4 mb-2 text-black bg-white rounded border hover:bg-orange-200 transition font-anonymouspro w-full text-left";
        choiceEl.id = `choice-${uppercaseKey}`;
        choiceEl.innerText = `${uppercaseKey}: ${value}`;
        return choiceEl;
    }
    ;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVlc3Rpb25zVmlldy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy92aWV3cy9xdWVzdGlvbnNWaWV3LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBb0IsYUFBYSxFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDL0UsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDbEUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQzNELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUMvQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFcEQsTUFBTSxFQUFFLGlCQUFpQixFQUFFLGdCQUFnQixFQUFFLFlBQVksRUFBRSxHQUFHLGFBQWEsQ0FBQztBQUM1RSxNQUFNLEVBQUUsd0JBQXdCLEVBQUUsaUNBQWlDLEVBQUUsZ0NBQWdDLEVBQUUsR0FBRyxnQkFBZ0IsQ0FBQztBQUMzSCxNQUFNLEVBQUUsb0JBQW9CLEVBQUUsc0JBQXNCLEVBQUUsR0FBRyxZQUFZLENBQUM7QUFFdEUsTUFBTSxXQUFXLEdBQUcsUUFBUSxDQUFDLGNBQWMsQ0FBQyxjQUFjLENBQXFCLENBQUM7QUFDaEYsTUFBTSxpQkFBaUIsR0FBRyxRQUFRLENBQUMsY0FBYyxDQUFDLHFCQUFxQixDQUFnQixDQUFDO0FBQ3hGLE1BQU0sY0FBYyxHQUFHLFFBQVEsQ0FBQyxjQUFjLENBQUMsZUFBZSxDQUFnQixDQUFDO0FBQy9FLE1BQU0sZ0JBQWdCLEdBQUcsUUFBUSxDQUFDLGNBQWMsQ0FBQyxtQkFBbUIsQ0FBZ0IsQ0FBQztBQUVyRixNQUFNLENBQUMsS0FBSyxVQUFVLGFBQWEsQ0FBQyxZQUF5QixFQUFFLGFBQTBCLEVBQUUsT0FBZTtJQUN0RyxNQUFNLE9BQU8sR0FBRyxRQUFR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O0FBRU4sQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJhc2VRdWVzdGlvblR5cGUsIFF1ZXN0aW9uVHlwZXMgfSBmcm9tIFwiLi4vdHlwZXMvQmFzZVF1ZXN0aW9uVHlwZS5qc1wiO1xuaW1wb3J0IHsgcHJlcGFyZVF1ZXN0aW9uU2V0IH0gZnJvbSBcIi4uL3V0aWxzL3F1ZXN0aW9uc01hbmFnZXIuanNcIjtcbmltcG9ydCB7IGlzQW5zd2VyVmFsaWQgfSBmcm9tIFwiLi4vdXRpbHMvYW5zd2Vyc01hbmFnZXIuanNcIjtcbmltcG9ydCB7IHN0YXJ0Q291bnRkb3duVGltZXIgfSBmcm9tIFwiLi4vdXRpbHMvdGltZXJNYW5hZ2VyLmpzXCI7XG5pbXBvcnQgeyByZXN1bHRzVmlldyB9IGZyb20gXCIuL3Jlc3VsdHNWaWV3LmpzXCI7XG5pbXBvcnQgeyBDb25maWd1cmF0aW9uIH0gZnJvbSBcIi4uL2NvbW1vbi9jb25maWcuanNcIjtcblxuY29uc3QgeyBBcHBsaWNhdGlvbkNvbmZpZywgQmFja2dyb3VuZENvbG9ycywgQm9yZGVyQ29sb3JzIH0gPSBDb25maWd1cmF0aW9uO1xuY29uc3QgeyBNVUxUSVBMRV9DSE9JQ0VfQkdfQ09MT1IsIE1VTFRJUExFX0NIT0lDRV9TRUxFQ1RFRF9CR19DT0xPUiwgTVVMVElQTEVfQ0hPSUNFX0NPUlJFQ1RfQkdfQ09MT1IgfSA9IEJhY2tncm91bmRDb2xvcnM7XG5jb25zdCB7IENPUlJFQ1RfQk9SREVSX0NPTE9SLCBJTkNPUlJFQ1RfQk9SREVSX0NPTE9SIH0gPSBCb3JkZXJDb2xvcnM7XG5cbmNvbnN0IGFuc3dlcklucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJhbnN3ZXItaW5wdXRcIikgYXMgSFRNTElucHV0RWxlbWVudDtcbmNvbnN0IGNvcnJlY3RBbnN3ZXJUZXh0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJjb3JyZWN0LWFuc3dlci10ZXh0XCIpIGFzIEhUTUxFbGVtZW50O1xuY29uc3QgcXVlc3Rpb25UZXh0RWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInF1ZXN0aW9uLXRleHRcIikgYXMgSFRNTEVsZW1lbnQ7XG5jb25zdCBjaG9pY2VzQ29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJjaG9pY2VzLWNvbnRhaW5lclwiKSBhcyBIVE1MRWxlbWVudDtcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHF1ZXN0aW9uc1ZpZXcoc3ViamVjdHNQYWdlOiBIVE1MRWxlbWVudCwgcXVlc3Rpb25zUGFnZTogSFRNTEVsZW1lbnQsIHN1YmplY3Q6IHN0cmluZykge1xuICAgIGNvbnN0IGJhY2tCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInF1ZXN0aW9ucy1iYWNrLWJ0blwiKSBhcyBIVE1MQnV0dG9uRWxlbWVudDtcbiAgICBjb25zdCBzdWJtaXRCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImFuc3dlci1zdWJtaXQtYnRuXCIpIGFzIEhUTUxCdXR0b25FbGVtZW50O1xuICAgIGxldCBzY29yZSA9IDA7XG4gICAgbGV0IGN1cnJlbnRRdWVzdGlvbkluZGV4ID0gMDtcblxuICAgIC8vIEV2ZW50IGxpc3RlbmVyc1xuICAgIGJhY2tCdG4uYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsICgpID0+IHtcbiAgICAgICAgc3ViamVjdHNQYWdlLmNsYXNzTGlzdC5yZW1vdmUoXCJoaWRkZW5cIik7XG4gICAgICAgIHF1ZXN0aW9uc1BhZ2UuY2xhc3NMaXN0LmFkZChcImhpZGRlblwiKTtcbiAgICB9KTtcblxuICAgIC8vIFVzZSBvbmNsaWNrIGluc3RlYWQgb2YgZXZlbnRMaXN0ZW5lclxuICAgIC8vIFRvIGF2b2lkIGxpc3RlbmVyIGdldHRpbmcgc3RhY2tlZCBtdWx0aXBsZSB0aW1lcyBvbiB0aGUgc2FtZSBidXR0b24uIFxuICAgIC8vIFRoaXMgY2F1c2VzIGhhbmRsZUFuc3dlclN1Ym1pc3Npb24oKSB0byBiZSBjYWxsZWQgbW9yZSB0aGFuIG9uY2Ug4oCUIGV2ZW4gd2l0aCBvdXRkYXRlZCBzdGF0ZS4gXG4gICAgc3VibWl0QnRuLm9uY2xpY2sgPSBoYW5kbGVBbnN3ZXJTdWJtaXNzaW9uO1xuXG4gICAgLy8gUHJlcGFyZSBhbmQgc2hvdyB0aGUgcXVlc3Rpb25zXG4gICAgY29uc3QgcXVlc3Rpb25zID0gYXdhaXQgcHJlcGFyZVF1ZXN0aW9uU2V0KHN1YmplY3QpO1xuICAgIHNob3dRdWVzdGlvbihjdXJyZW50UXVlc3Rpb25JbmRleCwgcXVlc3Rpb25zKTtcblxuICAgIC8vIEhhbmRsZSBhbnN3ZXIgc3VibWl0XG4gICAgZnVuY3Rpb24gaGFuZGxlQW5zd2VyU3VibWlzc2lvbigpIHtcbiAgICAgICAgY29uc3QgcXVlc3Rpb24gPSBxdWVzdGlvbnNbY3VycmVudFF1ZXN0aW9uSW5kZXhdO1xuICAgICAgICBjb25zdCB7IEFuc3dlcjogY29ycmVjdEFuc3dlciwgUXVlc3Rpb25UeXBlOiBxdWVzdGlvblR5cGUgfSA9IHF1ZXN0aW9uO1xuICAgICAgICBjb25zdCB1c2VyQW5zd2VyID0gYW5zd2VySW5wdXQudmFsdWU7XG4gICAgICAgIGNvbnN0IGlzVmFsaWQgPSBpc0Fuc3dlclZhbGlkKHVzZXJBbnN3ZXIsIHF1ZXN0aW9uKTtcbiAgICAgICAgY29uc3QgaXNNdWx0aXBsZUNob2ljZSA9IHF1ZXN0aW9uVHlwZSA9PT0gUXVlc3Rpb25UeXBlcy5NVUxUX0NIT0lDRSB8fCBxdWVzdGlvblR5cGUgPT09IFF1ZXN0aW9uVHlwZXMuTVVMVF9BTlNXRVI7XG5cbiAgICAgICAgaWYgKGlzTXVsdGlwbGVDaG9pY2UpIHtcbiAgICAgICAgICAgIGhhbmRsZU11bHRDaG9pY2VBbnN3ZXJGZWVkYmFjayhpc1ZhbGlkLCBjb3JyZWN0QW5zd2VyKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGhhbmRsZUFuc3dlckZlZWRiYWNrKGlzVmFsaWQpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFpc1ZhbGlkKSB7XG4gICAgICAgICAgICBjb3JyZWN0QW5zd2VyVGV4dC5jbGFzc0xpc3QucmVtb3ZlKFwiaW52aXNpYmxlXCIpO1xuICAgICAgICAgICAgY29ycmVjdEFuc3dlclRleHQuaW5uZXJUZXh0ID0gYENvcnJlY3QgQW5zd2VyOiAke2NvcnJlY3RBbnN3ZXJ9YDtcbiAgICAgICAgfVxuXG4gICAgICAgIHN1Ym1pdEJ0bi5kaXNhYmxlZCA9IHRydWU7XG5cbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICBhbnN3ZXJJbnB1dC5jbGFzc0xpc3QucmVtb3ZlKElOQ09SUkVDVF9CT1JERVJfQ09MT1IsIENPUlJFQ1RfQk9SREVSX0NPTE9SKTtcbiAgICAgICAgICAgIGNvcnJlY3RBbnN3ZXJUZXh0LmNsYXNzTGlzdC5hZGQoXCJpbnZpc2libGVcIik7XG4gICAgICAgICAgICBzdWJtaXRCdG4uZGlzYWJsZWQgPSBmYWxzZTtcblxuICAgICAgICAgICAgbW92ZVRvTmV4dFF1ZXN0aW9uKCk7XG4gICAgICAgIH0sIEFwcGxpY2F0aW9uQ29uZmlnLkRFTEFZX0JFRk9SRV9ORVhUX1FVRVNUSU9OKTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBtb3ZlVG9OZXh0UXVlc3Rpb24oKSB7XG4gICAgICAgIGN1cnJlbnRRdWVzdGlvbkluZGV4Kys7XG4gICAgICAgIGlmIChjdXJyZW50UXVlc3Rpb25JbmRleCA8IHF1ZXN0aW9ucy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHNob3dRdWVzdGlvbihjdXJyZW50UXVlc3Rpb25JbmRleCwgcXVlc3Rpb25zKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiQWxsIHF1ZXN0aW9ucyBjb21wbGV0ZWQhXCIpO1xuICAgICAgICAgICAgcmVzdWx0c1ZpZXcoc3ViamVjdHNQYWdlLCBxdWVzdGlvbnNQYWdlLCBzY29yZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBmdW5jdGlvbiBzaG93UXVlc3Rpb24oaW5kZXg6IG51bWJlciwgcXVlc3Rpb25zOiBCYXNlUXVlc3Rpb25UeXBlW10pIHtcbiAgICAgICAgY29uc3QgcSA9IHF1ZXN0aW9uc1tpbmRleF07XG4gICAgICAgIHF1ZXN0aW9uVGV4dEVsLmlubmVyVGV4dCA9IHEuUXVlc3Rpb247XG4gICAgICAgIGFuc3dlcklucHV0LnZhbHVlID0gXCJcIjtcblxuICAgICAgICAvLyBIYW5kbGUgbXVsdGlwbGUgY2hvaWNlIHF1ZXN0aW9uc1xuICAgICAgICBjb25zdCBzaG91bGRVc2VDaG9pY2VzID0gcS5RdWVzdGlvblR5cGUgPT09IFF1ZXN0aW9uVHlwZXMuTVVMVF9DSE9JQ0UgfHwgcS5RdWVzdGlvblR5cGUgPT09IFF1ZXN0aW9uVHlwZXMuTVVMVF9BTlNXRVI7XG4gICAgICAgIGFuc3dlcklucHV0LmNsYXNzTGlzdC50b2dnbGUoXCJoaWRkZW5cIiwgc2hvdWxkVXNlQ2hvaWNlcyk7XG4gICAgICAgIGNob2ljZXNDb250YWluZXIuaW5uZXJIVE1MID0gXCJcIjtcblxuICAgICAgICBpZiAoc2hvdWxkVXNlQ2hvaWNlcyAmJiBxLk9wdGlvbnMpIHtcbiAgICAgICAgICAgIGlmIChxLlF1ZXN0aW9uVHlwZSA9PT0gUXVlc3Rpb25UeXBlcy5NVUxUX0NIT0lDRSkge1xuICAgICAgICAgICAgICAgIGhhbmRsZU11bHRpcGxlQ2hvaWNlUXVlc3Rpb25zKHEpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBoYW5kbGVNdWx0aXBsZUFuc3dlcnNRdWVzdGlvbihxKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHN0YXJ0Q291bnRkb3duVGltZXIoaGFuZGxlQW5zd2VyU3VibWlzc2lvbik7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gaGFuZGxlQW5zd2VyRmVlZGJhY2soaXNDb3JyZWN0OiBib29sZWFuKSB7XG4gICAgICAgIGlmIChpc0NvcnJlY3QpIHtcbiAgICAgICAgICAgIGFuc3dlcklucHV0LmNsYXNzTGlzdC5hZGQoQ09SUkVDVF9CT1JERVJfQ09MT1IpO1xuICAgICAgICAgICAgc2NvcmUrKztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGFuc3dlcklucHV0LmNsYXNzTGlzdC5hZGQoSU5DT1JSRUNUX0JPUkRFUl9DT0xPUik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBmdW5jdGlvbiBoYW5kbGVNdWx0Q2hvaWNlQW5zd2VyRmVlZGJhY2soaXNDb3JyZWN0OiBib29sZWFuLCBjb3JyZWN0QW5zd2Vyczogc3RyaW5nW10gfCBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgaWYgKCFpc0NvcnJlY3QpIHJldHVyblxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShjb3JyZWN0QW5zd2VycykpIHtcbiAgICAgICAgICAgIGNvbnN0IGNvcnJlY3RBbnN3ZXIgPSBjb3JyZWN0QW5zd2Vycy5tYXAoYSA9PiBhLnRyaW0oKS50b1VwcGVyQ2FzZSgpKS5zb3J0KCk7XG4gICAgICAgICAgICBjb3JyZWN0QW5zd2VyLmZvckVhY2goYSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgY2hvaWNlRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChgY2hvaWNlLSR7YX1gKTtcbiAgICAgICAgICAgICAgICBpZiAoY2hvaWNlRWwpIHtcbiAgICAgICAgICAgICAgICAgICAgY2hvaWNlRWwuY2xhc3NMaXN0LnJlbW92ZShNVUxUSVBMRV9DSE9JQ0VfU0VMRUNURURfQkdfQ09MT1IpO1xuICAgICAgICAgICAgICAgICAgICBjaG9pY2VFbC5jbGFzc0xpc3QuYWRkKE1VTFRJUExFX0NIT0lDRV9DT1JSRUNUX0JHX0NPTE9SKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IHVwcGVyY2FzZUFuc3dlciA9IGNvcnJlY3RBbnN3ZXJzLnRyaW0oKS50b1VwcGVyQ2FzZSgpO1xuICAgICAgICAgICAgY29uc3QgY2hvaWNlRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChgY2hvaWNlLSR7dXBwZXJjYXNlQW5zd2VyfWApO1xuICAgICAgICAgICAgY2hvaWNlRWwhLmNsYXNzTGlzdC5yZW1vdmUoTVVMVElQTEVfQ0hPSUNFX1NFTEVDVEVEX0JHX0NPTE9SKTtcbiAgICAgICAgICAgIGNob2ljZUVsIS5jbGFzc0xpc3QuYWRkKE1VTFRJUExFX0NIT0lDRV9DT1JSRUNUX0JHX0NPTE9SKTtcbiAgICAgICAgfVxuICAgICAgICBzY29yZSsrO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGhhbmRsZU11bHRpcGxlQW5zd2Vyc1F1ZXN0aW9uKHE6IEJhc2VRdWVzdGlvblR5cGUpOiB2b2lkIHtcbiAgICAgICAgT2JqZWN0LmVudHJpZXMocS5PcHRpb25zISkuZm9yRWFjaCgoW2tleSwgdmFsdWVdKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjaG9pY2VFbCA9IGNyZWF0ZUNob2ljZUJ1dHRvbkVsKGtleSwgdmFsdWUpO1xuICAgICAgICAgICAgY2hvaWNlRWwuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsICgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCB3YXNTZWxlY3RlZCA9IGNob2ljZUVsLmNsYXNzTGlzdC5jb250YWlucyhNVUxUSVBMRV9DSE9JQ0VfU0VMRUNURURfQkdfQ09MT1IpO1xuICAgICAgICAgICAgICAgIGNob2ljZUVsLmNsYXNzTGlzdC50b2dnbGUoTVVMVElQTEVfQ0hPSUNFX1NFTEVDVEVEX0JHX0NPTE9SLCAhd2FzU2VsZWN0ZWQpO1xuICAgICAgICAgICAgICAgIGNob2ljZUVsLmNsYXNzTGlzdC50b2dnbGUoTVVMVElQTEVfQ0hPSUNFX0JHX0NPTE9SLCB3YXNTZWxlY3RlZCk7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBhbnN3ZXJzID0gYW5zd2VySW5wdXQudmFsdWUuc3BsaXQoJywnKS5tYXAoYSA9PiBhLnRyaW0oKSkuZmlsdGVyKEJvb2xlYW4pO1xuICAgICAgICAgICAgICAgIGlmICghd2FzU2VsZWN0ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFhbnN3ZXJzLmluY2x1ZGVzKGtleSkpIGFuc3dlcnMucHVzaChrZXkpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGlkeCA9IGFuc3dlcnMuaW5kZXhPZihrZXkpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoaWR4ID4gLTEpIGFuc3dlcnMuc3BsaWNlKGlkeCwgMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGFuc3dlcklucHV0LnZhbHVlID0gYW5zd2Vycy5qb2luKCcsJyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGNob2ljZXNDb250YWluZXIuYXBwZW5kQ2hpbGQoY2hvaWNlRWwpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBoYW5kbGVNdWx0aXBsZUNob2ljZVF1ZXN0aW9ucyhxOiBCYXNlUXVlc3Rpb25UeXBlKTogdm9pZCB7XG4gICAgICAgIE9iamVjdC5lbnRyaWVzKHEuT3B0aW9ucyEpLmZvckVhY2goKFtrZXksIHZhbHVlXSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY2hvaWNlRWwgPSBjcmVhdGVDaG9pY2VCdXR0b25FbChrZXksIHZhbHVlKTtcbiAgICAgICAgICAgIGNob2ljZUVsLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgQXJyYXkuZnJvbShjaG9pY2VzQ29udGFpbmVyLmNoaWxkcmVuKS5mb3JFYWNoKGJ0biA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QucmVtb3ZlKE1VTFRJUExFX0NIT0lDRV9TRUxFQ1RFRF9CR19DT0xPUik7XG4gICAgICAgICAgICAgICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKE1VTFRJUExFX0NIT0lDRV9CR19DT0xPUik7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgY2hvaWNlRWwuY2xhc3NMaXN0LmFkZChNVUxUSVBMRV9DSE9JQ0VfU0VMRUNURURfQkdfQ09MT1IpO1xuICAgICAgICAgICAgICAgIGNob2ljZUVsLmNsYXNzTGlzdC5yZW1vdmUoTVVMVElQTEVfQ0hPSUNFX0JHX0NPTE9SKTtcbiAgICAgICAgICAgICAgICBhbnN3ZXJJbnB1dC52YWx1ZSA9IGtleTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgY2hvaWNlc0NvbnRhaW5lci5hcHBlbmRDaGlsZChjaG9pY2VFbCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGNyZWF0ZUNob2ljZUJ1dHRvbkVsKGtleTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nKTogSFRNTEJ1dHRvbkVsZW1lbnQge1xuICAgICAgICBjb25zdCBjaG9pY2VFbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJidXR0b25cIik7XG4gICAgICAgIGNvbnN0IHVwcGVyY2FzZUtleSA9IGtleS50b1VwcGVyQ2FzZSgpO1xuICAgICAgICBjaG9pY2VFbC5jbGFzc05hbWUgPSBcImNob2ljZS1idG4gcHktMiBweC00IG1iLTIgdGV4dC1ibGFjayBiZy13aGl0ZSByb3VuZGVkIGJvcmRlciBob3ZlcjpiZy1vcmFuZ2UtMjAwIHRyYW5zaXRpb24gZm9udC1hbm9ueW1vdXNwcm8gdy1mdWxsIHRleHQtbGVmdFwiO1xuICAgICAgICBjaG9pY2VFbC5pZCA9IGBjaG9pY2UtJHt1cHBlcmNhc2VLZXl9YDtcbiAgICAgICAgY2hvaWNlRWwuaW5uZXJUZXh0ID0gYCR7dXBwZXJjYXNlS2V5fTogJHt2YWx1ZX1gO1xuICAgICAgICByZXR1cm4gY2hvaWNlRWw7XG4gICAgfTtcblxufSJdfQ==